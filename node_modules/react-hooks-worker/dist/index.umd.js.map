{"version":3,"file":"index.umd.js","sources":["../src/useWorker.ts","../src/exposeWorker.ts"],"sourcesContent":["import {\n  useEffect,\n  useMemo,\n  useRef,\n  useState,\n} from 'react';\n\ntype State<Result> = {\n  result?: Result;\n  error?: 'error' | 'messageerror';\n};\n\nconst initialState = {};\n\n/**\n * use worker\n *\n * The createWorker function should be stable to keep the worker running.\n * If it's referentially changed, it will create a new worker and terminate the old one.\n *\n * @example\n *\n * import { useWorker } from 'react-hooks-worker';\n *\n * const createWorker = () => new Worker(new URL('./slow_fib.worker', import.meta.url));\n *\n * const CalcFib = ({ count }) => {\n *   const { result, error } = useWorker(createWorker, count);\n *   if (error) return <div>Error: {error}</div>;\n *   return <div>Result: {result}</div>;\n * };\n */\nexport function useWorker<Input, Result>(\n  createWorker: () => Worker,\n  input: Input,\n  getOptions?: () => WindowPostMessageOptions,\n) {\n  const [state, setState] = useState<State<Result>>(initialState);\n  const worker = useMemo(createWorker, [createWorker]);\n  const lastWorker = useRef<Worker>(worker);\n  useEffect(() => {\n    lastWorker.current = worker;\n    let setStateSafe = (nextState: State<Result>) => setState(nextState);\n    worker.onmessage = (e) => setStateSafe({ result: e.data });\n    worker.onerror = () => setStateSafe({ error: 'error' });\n    worker.onmessageerror = () => setStateSafe({ error: 'messageerror' });\n    const cleanup = () => {\n      // eslint-disable-next-line react/function-component-definition\n      setStateSafe = () => null; // we should not setState after cleanup.\n      worker.terminate();\n      setState(initialState);\n    };\n    return cleanup;\n  }, [worker]);\n  useEffect(() => {\n    lastWorker.current.postMessage(input, getOptions?.());\n  }, [input, getOptions]);\n  return state;\n}\n","/* eslint-disable @typescript-eslint/no-explicit-any */\n\n/**\n * expose worker\n *\n * You can expose any function that returns:\n * - A value\n * - A promise\n * - An iterable\n * - An async iterable\n *\n * @example\n *\n * import { exposeWorker } from 'react-hooks-worker';\n *\n * const fib = (i) => (i <= 1 ? i : fib(i - 1) + fib(i - 2));\n *\n * exposeWorker(fib);\n */\nexport function exposeWorker(\n  func: (data: any) => any,\n  getOptions?: () => WindowPostMessageOptions,\n) {\n  self.onmessage = async (e: MessageEvent) => {\n    const r = func(e.data);\n    if (r && r[Symbol.asyncIterator]) {\n      for await (const i of r) (self.postMessage)(i, getOptions?.());\n    } else if (r && r[Symbol.iterator]) {\n      for (const i of r) (self.postMessage)(i, getOptions?.());\n    } else {\n      (self.postMessage)(await r, getOptions?.());\n    }\n  };\n}\n"],"names":["initialState","_Pact","this","o","_this","value","s","onFulfilled","onRejected","result","e","_settle","func","getOptions","self","onmessage","r","data","Promise","resolve","Symbol","asyncIterator","postMessage","iterator","_postMessage2","_self2","then","_r","_step2","_iterator2","_createForOfIteratorHelperLoose","done","_temp6","reject","useWorker","createWorker","input","_useState","useState","state","setState","worker","useMemo","lastWorker","useRef","useEffect","current","setStateSafe","nextState","onerror","error","onmessageerror","terminate"],"mappings":"6QAYA,IAAMA,EAAe,22BCVrB,IAAAC,eAAA,0KA+BC,OAVCC,KAAAC,EAAc,SAAAC,WAERC,EAAMD,IACC,EAATA,EAAAE,MAA8B,EAACC,EAAgBA,EAAYF,GAAIA,GAChEG,IAAMC,IAAWD,EAAOH,QACC,EAACA,GACpB,MAAAK,GACLC,EAAAF,EAAiB,EAAAC,KAGtBD,KA/BD,oLAiBgB,SACdG,EACAC,GAEAC,KAAKC,UAAmBL,SAAAA,GAAmB,IACzC,IAAMM,EAAIJ,EAAKF,EAAEO,MADwB,OAAAC,QAAAC,QAAA,WAAA,GAErCH,GAAKA,EAAEI,OAAOC,eACML,CAAAA,IAAAA,EAAAA,GAAAA,EAAAA,GAAAA,EAAAA,OAAAA,EAAAA,WAAAA,+BAAAA,WAAAA,MAAAA,uRAAAA,CAAAA,2xBAAIF,KAAKQ,YAALR,EAAAA,MAAqBD,MAAAA,OAAAA,EAAAA,4GAAzBG,CAAAA,iWACbA,IAAKA,EAAEI,OAAOG,UAGtBT,CAAAA,IAAAA,EAAAA,KAAAU,EAAAC,EAAKH,YAPiC,OAAAJ,QAAAC,QAOdH,GAPcU,KAAA,SAAAC,GAOvCH,EAA4BX,KAAAA,EAAAA,EAAAA,MAAAA,OAAAA,EAAAA,OAF5B,IAAA,IAAAe,EAAAC,2qBAAAC,CAAgBd,KAAhBY,EAAAC,KAAAE,MAAoBjB,KAAKQ,oBAAN,MAAsBT,OAAtB,EAAsBA,QAI5C,GAAAmB,GAAAA,EAAAN,KAAA,OAAAM,EAAAN,KAAA,cAT0C,IAA3C,MAUDhB,GAAA,OAAAQ,QAAAe,OAAAvB,kBDDewB,SACdC,EACAC,EACAvB,GAEA,IAAAwB,EAA0BC,WAAwBtC,GAA3CuC,OAAOC,EAAdH,EAAA,GACMI,EAASC,EAAAA,QAAQP,EAAc,CAACA,IAChCQ,EAAaC,EAAMA,OAASH,GAkBlC,OAjBAI,YAAU,WACRF,EAAWG,QAAUL,EACrB,IAAIM,EAAe,SAACC,UAA6BR,EAASQ,IAU1D,OATAP,EAAO1B,UAAY,SAACL,GAAMqC,OAAAA,EAAa,CAAEtC,OAAQC,EAAEO,QACnDwB,EAAOQ,QAAU,kBAAMF,EAAa,CAAEG,MAAO,WAC7CT,EAAOU,eAAiB,kBAAMJ,EAAa,CAAEG,MAAO,kBACpC,WAEdH,EAAe,WAAA,OAAA,MACfN,EAAOW,YACPZ,EAASxC,KAGV,CAACyC,IACJI,YAAU,WACRF,EAAWG,QAAQxB,YAAYc,EAAOvB,MAAAA,OAAAA,EAAAA,MACrC,CAACuB,EAAOvB,IACJ0B"}